from sqlalchemy import Column, Integer, Text, DateTime, ForeignKey, String, Boolean, JSON
from sqlalchemy.orm import relationship
from datetime import datetime
from .db import Base


class User(Base):
    __tablename__ = "users"

    id = Column(Integer, primary_key=True, index=True)
    email = Column(String, unique=True, index=True, nullable=False)
    hashed_password = Column(String, nullable=False)
    is_admin = Column(Boolean, default=False)
    has_submitted_feedback = Column(Boolean, default=False)
    reset_token = Column(String, nullable=True)

    responses = relationship("Response", back_populates="user")
    feedback_entries = relationship("Feedback", back_populates="user")
    archived_responses = relationship("ArchivedResponse", back_populates="user")
    unlocked_forms = relationship("UserFormUnlock", back_populates="user", cascade="all, delete-orphan")


class UserFormUnlock(Base):
    __tablename__ = "user_form_unlocks"

    id = Column(Integer, primary_key=True, index=True)
    user_id = Column(Integer, ForeignKey("users.id"), nullable=False)
    form_id = Column(Integer, ForeignKey("forms.id"), nullable=False)

    user = relationship("User", back_populates="unlocked_forms")
    form = relationship("FormModel", back_populates="unlocked_by_users")


class FormModel(Base):
    __tablename__ = "forms"

    id = Column(Integer, primary_key=True, index=True)
    title = Column(String, nullable=False)
    questions = Column(JSON, nullable=False)
    allow_join = Column(Boolean, default=True)
    join_code = Column(String, unique=True, nullable=False)

    rounds = relationship("RoundModel", back_populates="form", cascade="all, delete-orphan")
    responses = relationship("Response", back_populates="form", cascade="all, delete-orphan")
    archived_responses = relationship("ArchivedResponse", back_populates="form", cascade="all, delete-orphan")
    unlocked_by_users = relationship("UserFormUnlock", back_populates="form", cascade="all, delete-orphan")



class RoundModel(Base):
    __tablename__ = "rounds"

    id = Column(Integer, primary_key=True, index=True)
    form_id = Column(Integer, ForeignKey("forms.id"), nullable=False)
    round_number = Column(Integer, nullable=False)
    synthesis = Column(Text, nullable=True)
    is_active = Column(Boolean, default=True)
    questions = Column(JSON, nullable=True)

    form = relationship("FormModel", back_populates="rounds")
    responses = relationship("Response", back_populates="round")
    archived_responses = relationship("ArchivedResponse", back_populates="round")


class Response(Base):
    __tablename__ = "responses"

    id = Column(Integer, primary_key=True, index=True)
    form_id = Column(Integer, ForeignKey("forms.id"), nullable=False)
    user_id = Column(Integer, ForeignKey("users.id"), nullable=False)
    round_id = Column(Integer, ForeignKey("rounds.id"), nullable=False)
    answers = Column(JSON, nullable=False)
    created_at = Column(DateTime, default=datetime.utcnow)

    user = relationship("User", back_populates="responses")
    form = relationship("FormModel", back_populates="responses")
    round = relationship("RoundModel", back_populates="responses")


class ArchivedResponse(Base):
    __tablename__ = "archived_responses"

    id = Column(Integer, primary_key=True, index=True)
    form_id = Column(Integer, ForeignKey("forms.id"), nullable=False)
    user_id = Column(Integer, ForeignKey("users.id"), nullable=True)
    email = Column(String, nullable=True)
    answers = Column(JSON, nullable=False)
    created_at = Column(DateTime, default=datetime.utcnow)
    round_id = Column(Integer, ForeignKey("rounds.id"), nullable=True)

    user = relationship("User", back_populates="archived_responses")
    form = relationship("FormModel", back_populates="archived_responses")
    round = relationship("RoundModel", back_populates="archived_responses")


class Feedback(Base):
    __tablename__ = "feedback"

    id = Column(Integer, primary_key=True, index=True)
    accuracy = Column(Text)
    influence = Column(Text)
    further_thoughts = Column(Text)
    usability = Column(Text)
    summary = Column(Text)
    created_at = Column(DateTime, default=datetime.utcnow)
    user_id = Column(Integer, ForeignKey("users.id"), nullable=False)

    user = relationship("User", back_populates="feedback_entries")
